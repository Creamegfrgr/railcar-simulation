<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¨é“å¹³è½¦å‚ç›´æ­¢æŒ¡è£…ç½®åŠ¨åŠ›å­¦ä»¿çœŸç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0a1929 0%, #1a2b3c 100%);
            color: white;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(52, 152, 219, 0.2);
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 50%, #2c3e50 100%);
            color: white;
            padding: 25px 40px;
            text-align: center;
            border-bottom: 3px solid #27ae60;
        }
        
        h1 {
            font-size: 2.4em;
            margin-bottom: 10px;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .simulation-area {
            padding: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .simulation-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .animation-view {
            flex: 2;
            min-width: 600px;
            background: rgba(0, 20, 40, 0.8);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid rgba(52, 152, 219, 0.5);
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.2);
            position: relative;
        }
        
        .controls-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .simulation-canvas {
            width: 100%;
            height: 500px;
            background: linear-gradient(180deg, #0c1e30 0%, #1a3a5f 100%);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .device-labels {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #ecf0f1;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
            pointer-events: none;
        }
        
        .parameter-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ecf0f1;
            font-size: 0.95em;
        }
        
        input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            height: 6px;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.8);
        }
        
        .value-display {
            display: inline-block;
            width: 80px;
            text-align: right;
            font-weight: bold;
            color: #3498db;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .results-display {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .result-label {
            font-weight: 600;
            color: #ecf0f1;
        }
        
        .result-value {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .chart-area {
            padding: 30px;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }
        
        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #ecf0f1;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .chart-container {
            height: 250px;
            position: relative;
        }
        
        .scenario-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .scenario-btn {
            padding: 8px 16px;
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.5);
            border-radius: 4px;
            color: #ecf0f1;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        
        .scenario-btn:hover {
            background: rgba(52, 152, 219, 0.4);
            transform: translateY(-2px);
        }
        
        .scenario-btn.active {
            background: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .status-safe {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        
        .status-warning {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border: 1px solid #f39c12;
        }
        
        .status-danger {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .status-failure {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
            border: 1px solid #9b59b6;
        }
        
        .buffer-effect {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 20px;
            background: linear-gradient(90deg, #000000, #333333);
            border-radius: 10px;
            transition: height 0.3s ease;
            z-index: 2;
        }
        
        .buffer-compression {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 30px;
            background: rgba(52, 152, 219, 0.3);
            border: 2px dashed rgba(52, 152, 219, 0.6);
            border-radius: 5px;
            z-index: 1;
            pointer-events: none;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .animation-view, .controls-panel {
                min-width: 100%;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .parameter-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>è½¨é“å¹³è½¦å‚ç›´æ­¢æŒ¡è£…ç½®åŠ¨åŠ›å­¦ä»¿çœŸç³»ç»Ÿ</h1>
            <p class="subtitle">å‚ç›´æ–¹å‘ç¢°æ’æ¨¡æ‹Ÿ | æ¶²å‹ç¼“å†²ç³»ç»ŸåŠ¨æ€æ¼”ç¤º</p>
        </header>
        
        <div class="simulation-area">
            <div class="simulation-container">
                <div class="animation-view">
                    <h2 style="margin-bottom: 15px; color: #ecf0f1; text-align: center;">ç¼“å†²è¿‡ç¨‹åŠ¨æ€æ¼”ç¤º</h2>
                    <div class="simulation-canvas">
                        <canvas id="animationCanvas"></canvas>
                        <div class="device-labels" id="deviceLabels">
                            ç¼“å†²å«: æœªå‹ç¼© | æ¶²å‹ç¼¸: å¾…å‘½ | å®‰å…¨ç­‰çº§: æ­£å¸¸
                        </div>
                        <div class="buffer-compression" id="bufferZone"></div>
                    </div>
                </div>
                
                <div class="controls-panel">
                    <h2 style="margin-bottom: 20px; color: #ecf0f1; text-align: center;">ä»¿çœŸå‚æ•°è®¾ç½®</h2>
                    
                    <div class="parameter-controls">
                        <div class="control-group">
                            <label for="massControl">å¹³è½¦è´¨é‡: <span class="value-display" id="massValue">30 å¨</span></label>
                            <input type="range" id="massControl" min="10" max="50" step="5" value="30">
                        </div>
                        
                        <div class="control-group">
                            <label for="speedControl">ç¢°æ’é€Ÿåº¦: <span class="value-display" id="speedValue">3.0 m/s</span></label>
                            <input type="range" id="speedControl" min="0.5" max="6.0" step="0.1" value="3.0">
                        </div>
                        
                        <div class="control-group">
                            <label for="bufferType">ç¼“å†²ç±»å‹: <span class="value-display" id="bufferTypeValue">æ¶²å‹+å¼¹æ€§</span></label>
                            <input type="range" id="bufferType" min="1" max="3" step="1" value="2">
                        </div>
                        
                        <div class="control-group">
                            <label for="dampingControl">é˜»å°¼ç³»æ•°: <span class="value-display" id="dampingValue">0.7</span></label>
                            <input type="range" id="dampingControl" min="0.1" max="1.0" step="0.1" value="0.7">
                        </div>
                    </div>
                    
                    <h3 style="color: #ecf0f1; margin-top: 20px; margin-bottom: 10px;">å…¸å‹å·¥å†µæ¨¡æ‹Ÿ</h3>
                    <div class="scenario-buttons">
                        <button class="scenario-btn" data-speed="1.5">å¼¹æ€§ç¼“å†² (1.5 m/s)</button>
                        <button class="scenario-btn" data-speed="2.5">æ¶²å‹ä»‹å…¥ (2.5 m/s)</button>
                        <button class="scenario-btn active" data-speed="3.0">è®¾è®¡å·¥å†µ (3.0 m/s)</button>
                        <button class="scenario-btn" data-speed="4.0">æé™ç¼“å†² (4.0 m/s)</button>
                        <button class="scenario-btn" data-speed="5.0">ç»“æ„å˜å½¢ (5.0 m/s)</button>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" id="startBtn">â–¶ å¼€å§‹ç¼“å†²æ¼”ç¤º</button>
                        <button class="btn btn-success" id="pauseBtn">â¸ æš‚åœ/ç»§ç»­</button>
                        <button class="btn btn-warning" id="resetBtn">â†º é‡ç½®</button>
                        <button class="btn btn-danger" id="slowBtn">ğŸŒ æ…¢æ”¾æ¨¡å¼</button>
                    </div>
                    
                    <div class="results-display">
                        <h3 style="margin-bottom: 15px; color: #ecf0f1; text-align: center;">ç¼“å†²è¿‡ç¨‹ç›‘æ§</h3>
                        <div class="result-grid">
                            <div class="result-item">
                                <span class="result-label">ç¼“å†²å«å‹ç¼©:</span>
                                <span class="result-value" id="bufferCompression">0%</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">æ¶²å‹å‹åŠ›:</span>
                                <span class="result-value" id="hydraulicPressure">0 MPa</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">å³°å€¼å†²å‡»åŠ›:</span>
                                <span class="result-value" id="peakForce">0.0 kN</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">å‡é€Ÿåº¦å³°å€¼:</span>
                                <span class="result-value" id="maxDeceleration">0.0 g</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">èƒ½é‡å¸æ”¶:</span>
                                <span class="result-value" id="energyAbsorbed">0%</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">ç¼“å†²çŠ¶æ€:</span>
                                <span class="status-indicator status-safe" id="bufferStatus">å¾…å‘½</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-area">
            <h2 style="margin-bottom: 25px; text-align: center; color: #ecf0f1;">ç¼“å†²ç³»ç»ŸåŠ¨æ€å“åº”</h2>
            
            <div class="charts-container">
                <div class="chart-box">
                    <div class="chart-title">å†²å‡»åŠ›å˜åŒ–è¿‡ç¨‹</div>
                    <div class="chart-container">
                        <canvas id="forceChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-box">
                    <div class="chart-title">ç¼“å†²å«å‹ç¼©å†ç¨‹</div>
                    <div class="chart-container">
                        <canvas id="compressionChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-box">
                    <div class="chart-title">èƒ½é‡å¸æ”¶è¿‡ç¨‹</div>
                    <div class="chart-container">
                        <canvas id="energyChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-box">
                    <div class="chart-title">æ¶²å‹ç³»ç»Ÿå‹åŠ›</div>
                    <div class="chart-container">
                        <canvas id="pressureChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div style="background: rgba(0, 0, 0, 0.2); padding: 25px; border-radius: 10px; margin-top: 30px;">
                <h2 style="color: #ecf0f1; margin-bottom: 20px; text-align: center;">ç¼“å†²æœºç†è¯´æ˜</h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                        <h4 style="color: #3498db; margin-bottom: 10px;">1. å¼¹æ€§ç¼“å†²é˜¶æ®µ</h4>
                        <p style="color: #ecf0f1; font-size: 0.9em;">èšæ°¨é…¯ç¼“å†²å«å‘ç”Ÿå¼¹æ€§å˜å½¢ï¼Œå¸æ”¶åˆå§‹å†²å‡»èƒ½é‡ï¼Œé€Ÿåº¦â‰¤1.5m/sæ—¶å¯å®Œå…¨æ¢å¤ã€‚</p>
                    </div>
                    <div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #f39c12;">
                        <h4 style="color: #f39c12; margin-bottom: 10px;">2. æ¶²å‹é˜»å°¼é˜¶æ®µ</h4>
                        <p style="color: #ecf0f1; font-size: 0.9em;">æ¶²å‹ç³»ç»Ÿä»‹å…¥ï¼Œæä¾›å¯æ§é˜»å°¼åŠ›ï¼Œçº¿æ€§è€—æ•£èƒ½é‡ï¼Œé˜²æ­¢å†²å‡»åŠ›æ€¥å‰§ä¸Šå‡ã€‚</p>
                    </div>
                    <div style="background: rgba(231, 76, 60, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                        <h4 style="color: #e74c3c; margin-bottom: 10px;">3. ç»“æ„é™ä½é˜¶æ®µ</h4>
                        <p style="color: #ecf0f1; font-size: 0.9em;">é«˜å¼ºåº¦é’¢ç»“æ„é™åˆ¶æœ€å¤§å‹ç¼©é‡ï¼Œä¸ºå†²å‡»æä¾›æœ€ç»ˆçš„å®‰å…¨å±éšœã€‚</p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Â© 2023 è½¨é“å®‰å…¨å·¥ç¨‹æŠ€æœ¯ç ”ç©¶ä¸­å¿ƒ | ç¼“å†²ç³»ç»ŸåŠ¨æ€ä»¿çœŸç³»ç»Ÿ V4.0 | åŸºäºå¤šçº§ç¼“å†²ç†è®ºä¸æ¶²å‹æ§åˆ¶æ¨¡å‹</p>
        </footer>
    </div>

    <script>
        // ä»¿çœŸå‚æ•°
        let simulationParams = {
            mass: 30000,        // kg (30å¨)
            speed: 3.0,         // m/s
            bufferType: 2,      // ç¼“å†²ç±»å‹ 1-3
            damping: 0.7,       // é˜»å°¼ç³»æ•°
            isRunning: false,
            isPaused: false,
            slowMode: false,
            time: 0,
            maxTime: 5.0,
            simulationComplete: false
        };

        // ç¼“å†²ç³»ç»ŸçŠ¶æ€
        let bufferSystem = {
            compression: 0,      // å½“å‰å‹ç¼©é‡ (0-1)
            hydraulicPressure: 0, // æ¶²å‹å‹åŠ› (MPa)
            energyAbsorbed: 0,   // èƒ½é‡å¸æ”¶æ¯”ä¾‹
            maxCompression: 0.15, // æœ€å¤§å‹ç¼©é‡ (m)
            stage: 'idle',       // å½“å‰é˜¶æ®µ: idle, elastic, hydraulic, structural
            compressionRate: 0   // å‹ç¼©é€Ÿç‡
        };

        // ä»¿çœŸç»“æœæ•°æ®
        let simulationData = {
            time: [],
            force: [],
            compression: [],
            pressure: [],
            energy: [],
            velocity: [],
            stage: []
        };

        // å›¾è¡¨å®ä¾‹
        let forceChart, compressionChart, energyChart, pressureChart;

        // åŠ¨ç”»å‚æ•°
        let animationId = null;
        let animationFrame = 0;
        const canvas = document.getElementById('animationCanvas');
        const ctx = canvas.getContext('2d');
        const deviceLabels = document.getElementById('deviceLabels');
        const bufferZone = document.getElementById('bufferZone');

        // è®¾ç½®Canvaså°ºå¯¸
        function resizeCanvas() {
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            updateBufferZone();
        }

        // æ›´æ–°ç¼“å†²åŒºåŸŸæ˜¾ç¤º
        function updateBufferZone() {
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            bufferZone.style.width = '120px';
            bufferZone.style.height = `${bufferSystem.maxCompression * 200}px`;
            bufferZone.style.bottom = `${150 - bufferSystem.maxCompression * 100}px`;
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#ecf0f1'
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'æ—¶é—´ (s)',
                            color: '#ecf0f1'
                        },
                        ticks: {
                            color: '#ecf0f1'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'æ•°å€¼',
                            color: '#ecf0f1'
                        },
                        ticks: {
                            color: '#ecf0f1'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            };

            // å†²å‡»åŠ›å›¾è¡¨
            forceChart = new Chart(document.getElementById('forceChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å†²å‡»åŠ› (kN)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: {
                            suggestedMin: 0,
                            suggestedMax: 400
                        }
                    }
                }
            });

            // å‹ç¼©å›¾è¡¨
            compressionChart = new Chart(document.getElementById('compressionChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ç¼“å†²å«å‹ç¼© (m)',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: {
                            suggestedMin: 0,
                            suggestedMax: 0.15
                        }
                    }
                }
            });

            // èƒ½é‡å›¾è¡¨
            energyChart = new Chart(document.getElementById('energyChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'å¹³è½¦åŠ¨èƒ½ (kJ)',
                            data: [],
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0
                        },
                        {
                            label: 'å¸æ”¶èƒ½é‡ (kJ)',
                            data: [],
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0
                        }
                    ]
                },
                options: chartOptions
            });

            // å‹åŠ›å›¾è¡¨
            pressureChart = new Chart(document.getElementById('pressureChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æ¶²å‹å‹åŠ› (MPa)',
                        data: [],
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.2)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: {
                            suggestedMin: 0,
                            suggestedMax: 40
                        }
                    }
                }
            });
        }

        // æ ¹æ®é€Ÿåº¦è®¡ç®—é¢„æœŸçš„å†²å‡»åŠ›
        function calculateExpectedForce(speed) {
            // åŸºäºæ‚¨çš„æ•°æ®è¡¨
            if (speed <= 1.5) return 42;
            if (speed <= 2.0) return 75;
            if (speed <= 2.5) return 117;
            if (speed <= 3.0) return 169;
            if (speed <= 3.5) return 230;
            if (speed <= 4.0) return 300;
            if (speed <= 4.5) return 380;
            if (speed <= 5.0) return 500;
            return 800; // >5.0 m/s
        }

        // æ›´æ–°ç¼“å†²ç³»ç»ŸçŠ¶æ€
        function updateBufferSystem(progress, speed) {
            const expectedForce = calculateExpectedForce(speed);
            
            // è®¡ç®—å‹ç¼©è¿›åº¦ï¼ˆéçº¿æ€§ï¼‰
            let compressionProgress;
            if (progress < 0.3) {
                // åˆå§‹æ¥è§¦é˜¶æ®µ
                compressionProgress = progress / 0.3 * 0.3;
                bufferSystem.stage = 'elastic';
            } else if (progress < 0.7) {
                // ä¸»è¦ç¼“å†²é˜¶æ®µ
                compressionProgress = 0.3 + (progress - 0.3) / 0.4 * 0.5;
                bufferSystem.stage = 'hydraulic';
            } else {
                // ç¨³å®šé˜¶æ®µ
                compressionProgress = 0.8 + (progress - 0.7) / 0.3 * 0.2;
                bufferSystem.stage = 'structural';
            }
            
            bufferSystem.compression = Math.min(compressionProgress, 1) * bufferSystem.maxCompression;
            
            // è®¡ç®—æ¶²å‹å‹åŠ›ï¼ˆä¸å†²å‡»åŠ›ç›¸å…³ï¼‰
            bufferSystem.hydraulicPressure = expectedForce / 10 * progress; // ç®€åŒ–è®¡ç®—
            
            // è®¡ç®—èƒ½é‡å¸æ”¶
            bufferSystem.energyAbsorbed = Math.min(progress * 0.9, 1) * 100;
            
            // è®¡ç®—å‹ç¼©é€Ÿç‡
            bufferSystem.compressionRate = speed * (1 - progress);
            
            return {
                compression: bufferSystem.compression,
                pressure: bufferSystem.hydraulicPressure,
                energyAbsorbed: bufferSystem.energyAbsorbed,
                stage: bufferSystem.stage
            };
        }

        // æ›´æ–°è®¾å¤‡æ ‡ç­¾
        function updateDeviceLabels(bufferState) {
            let stageText = '';
            switch(bufferState.stage) {
                case 'elastic':
                    stageText = 'å¼¹æ€§ç¼“å†²';
                    break;
                case 'hydraulic':
                    stageText = 'æ¶²å‹é˜»å°¼';
                    break;
                case 'structural':
                    stageText = 'ç»“æ„é™ä½';
                    break;
                default:
                    stageText = 'å¾…å‘½çŠ¶æ€';
            }
            
            deviceLabels.textContent = 
                `ç¼“å†²å«: ${(bufferState.compression * 100).toFixed(1)}% | ` +
                `æ¶²å‹å‹åŠ›: ${bufferState.pressure.toFixed(1)} MPa | ` +
                `é˜¶æ®µ: ${stageText}`;
        }

        // è¿è¡Œä»¿çœŸè®¡ç®—
        function runSimulation() {
            // é‡ç½®æ•°æ®
            simulationData = {
                time: [],
                force: [],
                compression: [],
                pressure: [],
                energy: [],
                velocity: [],
                stage: []
            };

            bufferSystem = {
                compression: 0,
                hydraulicPressure: 0,
                energyAbsorbed: 0,
                maxCompression: 0.15,
                stage: 'idle',
                compressionRate: 0
            };

            const dt = 0.001; // æ—¶é—´æ­¥é•¿
            let time = 0;
            let velocity = simulationParams.speed;
            let maxForce = 0;
            let maxDeceleration = 0;
            let maxCompression = 0;

            // åˆå§‹åŠ¨èƒ½
            const initialKineticEnergy = 0.5 * simulationParams.mass * Math.pow(simulationParams.speed, 2);
            
            // è¿è¡Œä»¿çœŸå¾ªç¯
            while (time < simulationParams.maxTime) {
                const progress = Math.min(time / 2.0, 1); // å‡è®¾2ç§’å®Œæˆä¸»è¦ç¼“å†²
                
                // æ›´æ–°ç¼“å†²ç³»ç»ŸçŠ¶æ€
                const bufferState = updateBufferSystem(progress, simulationParams.speed);
                
                // è®¡ç®—å½“å‰å†²å‡»åŠ›ï¼ˆåŸºäºç¼“å†²çŠ¶æ€ï¼‰
                let currentForce;
                switch(bufferState.stage) {
                    case 'elastic':
                        currentForce = calculateExpectedForce(simulationParams.speed) * 0.3 * progress / 0.3;
                        break;
                    case 'hydraulic':
                        currentForce = calculateExpectedForce(simulationParams.speed) * (0.3 + 0.5 * (progress - 0.3) / 0.4);
                        break;
                    case 'structural':
                        currentForce = calculateExpectedForce(simulationParams.speed) * (0.8 + 0.2 * (progress - 0.7) / 0.3);
                        break;
                    default:
                        currentForce = 0;
                }
                
                // è®¡ç®—å‡é€Ÿåº¦
                const deceleration = currentForce * 1000 / simulationParams.mass; // kNè½¬æ¢ä¸ºNå†é™¤ä»¥è´¨é‡
                
                // æ›´æ–°é€Ÿåº¦ï¼ˆç®€åŒ–æ¨¡å‹ï¼‰
                velocity = simulationParams.speed * (1 - progress * 0.9);
                
                // è®°å½•æœ€å¤§å€¼
                if (currentForce > maxForce) maxForce = currentForce;
                if (deceleration > maxDeceleration) maxDeceleration = deceleration;
                if (bufferState.compression > maxCompression) maxCompression = bufferState.compression;

                // å­˜å‚¨æ•°æ®ç‚¹
                if (time % 0.01 < dt) {
                    simulationData.time.push(time.toFixed(3));
                    simulationData.force.push(currentForce);
                    simulationData.compression.push(bufferState.compression);
                    simulationData.pressure.push(bufferState.pressure);
                    simulationData.energy.push(initialKineticEnergy * (1 - progress) / 1000);
                    simulationData.velocity.push(velocity);
                    simulationData.stage.push(bufferState.stage);
                }
                
                time += dt;
                
                // å¦‚æœç¼“å†²å®Œæˆï¼Œæå‰ç»“æŸ
                if (progress >= 1) break;
            }

            // æ›´æ–°ç»“æœæ˜¾ç¤º
            updateResults(maxForce, maxDeceleration, maxCompression);
            
            simulationParams.simulationComplete = true;
            
            // å»¶è¿Ÿæ›´æ–°å›¾è¡¨
            setTimeout(updateCharts, 100);
            
            return { maxForce, maxDeceleration, maxCompression, time };
        }

        // æ›´æ–°ç»“æœæ˜¾ç¤º
        function updateResults(maxForce, maxDeceleration, maxCompression) {
            document.getElementById('peakForce').textContent = maxForce.toFixed(1) + ' kN';
            document.getElementById('maxDeceleration').textContent = (maxDeceleration / 9.8).toFixed(2) + ' g';
            document.getElementById('bufferCompression').textContent = (maxCompression / bufferSystem.maxCompression * 100).toFixed(1) + '%';
        }

        // æ›´æ–°ç¼“å†²çŠ¶æ€æ˜¾ç¤º
        function updateBufferStatus() {
            const statusElement = document.getElementById('bufferStatus');
            const pressureElement = document.getElementById('hydraulicPressure');
            const energyElement = document.getElementById('energyAbsorbed');
            
            pressureElement.textContent = bufferSystem.hydraulicPressure.toFixed(1) + ' MPa';
            energyElement.textContent = bufferSystem.energyAbsorbed.toFixed(1) + '%';
            
            switch(bufferSystem.stage) {
                case 'elastic':
                    statusElement.className = 'status-indicator status-safe';
                    statusElement.textContent = 'å¼¹æ€§ç¼“å†²';
                    break;
                case 'hydraulic':
                    statusElement.className = 'status-indicator status-warning';
                    statusElement.textContent = 'æ¶²å‹ä»‹å…¥';
                    break;
                case 'structural':
                    statusElement.className = 'status-indicator status-danger';
                    statusElement.textContent = 'ç»“æ„é™ä½';
                    break;
                default:
                    statusElement.className = 'status-indicator status-safe';
                    statusElement.textContent = 'å¾…å‘½';
            }
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts() {
            if (simulationData.time.length === 0) return;
            
            // é™åˆ¶æ•°æ®ç‚¹æ•°é‡ä»¥æé«˜æ€§èƒ½
            const maxPoints = 200;
            const step = Math.ceil(simulationData.time.length / maxPoints);
            
            const sampledTime = [];
            const sampledForce = [];
            const sampledCompression = [];
            const sampledPressure = [];
            const sampledEnergy = [];
            
            for (let i = 0; i < simulationData.time.length; i += step) {
                sampledTime.push(simulationData.time[i]);
                sampledForce.push(simulationData.force[i]);
                sampledCompression.push(simulationData.compression[i]);
                sampledPressure.push(simulationData.pressure[i]);
                sampledEnergy.push(simulationData.energy[i]);
            }
            
            // æ›´æ–°å†²å‡»åŠ›å›¾è¡¨
            forceChart.data.labels = sampledTime;
            forceChart.data.datasets[0].data = sampledForce;
            forceChart.update();
            
            // æ›´æ–°å‹ç¼©å›¾è¡¨
            compressionChart.data.labels = sampledTime;
            compressionChart.data.datasets[0].data = sampledCompression;
            compressionChart.update();
            
            // æ›´æ–°èƒ½é‡å›¾è¡¨
            energyChart.data.labels = sampledTime;
            energyChart.data.datasets[0].data = sampledEnergy;
            energyChart.data.datasets[1].data = sampledEnergy.map(e => e * 0.8); // ç®€åŒ–å¸æ”¶èƒ½é‡è®¡ç®—
            energyChart.update();
            
            // æ›´æ–°å‹åŠ›å›¾è¡¨
            pressureChart.data.labels = sampledTime;
            pressureChart.data.datasets[0].data = sampledPressure;
            pressureChart.update();
        }

        // ç»˜åˆ¶ç¼“å†²è£…ç½®ç»†èŠ‚
        function drawBufferDeviceDetail(x, y, bufferHeight) {
            const width = canvas.width;
            const height = canvas.height;
            
            // æ··å‡åœŸåŸºç¡€
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(x - 80, y, 160, 80);
            
            // ç¼“å†²å«ï¼ˆå¸¦å‹ç¼©æ•ˆæœï¼‰
            const bufferCompression = bufferHeight;
            const bufferThickness = 30;
            const compressedHeight = bufferThickness - bufferCompression;
            
            // ç¼“å†²å«ä¸»ä½“
            const gradient = ctx.createLinearGradient(x - 60, y - bufferThickness, x - 60, y);
            gradient.addColorStop(0, '#000000');
            gradient.addColorStop(1, '#333333');
            ctx.fillStyle = gradient;
            ctx.fillRect(x - 60, y - compressedHeight, 120, compressedHeight);
            
            // ç¼“å†²å«å‹ç¼©çº¹ç†
            ctx.strokeStyle = '#555555';
            ctx.lineWidth = 2;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(x - 50 + i * 25, y - compressedHeight);
                ctx.lineTo(x - 50 + i * 25, y);
                ctx.stroke();
            }
            
            // æ¶²å‹ç¼¸
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(x - 40, y - 150, 80, 70);
            
            // æ¶²å‹æ´»å¡
            const pistonPosition = y - 150 + 70 - bufferCompression * 30;
            ctx.fillStyle = '#34495e';
            ctx.fillRect(x - 30, pistonPosition, 60, 20);
            
            // æ¶²å‹ç®¡è·¯
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(x - 20, y - 80);
            ctx.lineTo(x - 40, y - 120);
            ctx.lineTo(x - 60, y - 140);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(x + 20, y - 80);
            ctx.lineTo(x + 40, y - 120);
            ctx.lineTo(x + 60, y - 140);
            ctx.stroke();
            
            // æ¶²å‹å‹åŠ›æŒ‡ç¤º
            if (bufferSystem.hydraulicPressure > 0) {
                const pressureHeight = bufferSystem.hydraulicPressure * 2;
                ctx.fillStyle = 'rgba(231, 76, 60, 0.3)';
                ctx.fillRect(x - 40, y - 150, 80, pressureHeight);
                
                // å‹åŠ›å€¼
                ctx.fillStyle = '#e74c3c';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${bufferSystem.hydraulicPressure.toFixed(1)} MPa`, x, y - 160);
            }
            
            // ç»“æ„æ¡†æ¶
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 3;
            ctx.strokeRect(x - 50, y - 160, 100, 160);
            
            // èºæ “è¿æ¥ç‚¹
            ctx.fillStyle = '#ecf0f1';
            for (let i = 0; i < 4; i++) {
                ctx.beginPath();
                ctx.arc(x - 45 + i * 30, y + 20, 6, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // ç»˜åˆ¶å¹³è½¦
        function drawRailcar(x, y, width, height) {
            // è½¦èº«
            const gradient = ctx.createLinearGradient(x, y, x, y + height);
            gradient.addColorStop(0, '#e74c3c');
            gradient.addColorStop(1, '#c0392b');
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, width, height);
            
            // è½¦é¡¶
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(x + 10, y - 10, width - 20, 10);
            
            // è½¦è½®
            ctx.fillStyle = '#34495e';
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc(x + 25 + i * 40, y + height, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // è½®æ¯‚
                ctx.fillStyle = '#ecf0f1';
                ctx.beginPath();
                ctx.arc(x + 25 + i * 40, y + height, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#34495e';
            }
            
            // è½½é‡æ ‡è¯†
            ctx.fillStyle = '#ecf0f1';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${simulationParams.mass/1000}T`, x + width/2, y + height/2 + 5);
        }

        // ç»˜åˆ¶å†²å‡»åŠ›æŒ‡ç¤º
        function drawForceIndicator(x, y, force) {
            const indicatorLength = Math.min(force * 0.5, 150);
            
            ctx.save();
            ctx.translate(x, y);
            
            // åŠ›çŸ¢é‡çº¿
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(0, indicatorLength);
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            // åŠ›å€¼æ˜¾ç¤º
            ctx.fillStyle = '#e74c3c';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`${force.toFixed(1)} kN`, 10, indicatorLength/2);
            
            // åŠ›å€¼åˆ»åº¦
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const yPos = indicatorLength * i / 5;
                ctx.beginPath();
                ctx.moveTo(-10, yPos);
                ctx.lineTo(10, yPos);
                ctx.stroke();
                
                ctx.fillStyle = '#ecf0f1';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(`${(force * i / 5).toFixed(0)}`, -15, yPos + 3);
            }
            
            ctx.restore();
        }

        // ç»˜åˆ¶èƒ½é‡æµåŠ¨ç”»
        function drawEnergyFlow(carX, carY, bufferX, bufferY, progress) {
            const energyCount = 5;
            
            for (let i = 0; i < energyCount; i++) {
                const phase = (progress + i / energyCount) % 1;
                const x = carX + (bufferX - carX) * phase;
                const y = carY + (bufferY - carY) * phase;
                const size = 8 * (1 - Math.abs(phase - 0.5) * 2);
                
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                
                const gradient = ctx.createRadialGradient(x, y, 0, x, y, size);
                gradient.addColorStop(0, 'rgba(243, 156, 18, 0.8)');
                gradient.addColorStop(1, 'rgba(243, 156, 18, 0)');
                
                ctx.fillStyle = gradient;
                ctx.fill();
            }
        }

        // ç»˜åˆ¶åˆå§‹çŠ¶æ€
        function drawInitialState() {
            const width = canvas.width;
            const height = canvas.height;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#0c1e30');
            gradient.addColorStop(1, '#1a3a5f');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // ç»˜åˆ¶åœ°é¢
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(0, height - 100, width, 100);
            
            // åœ°é¢çº¹ç†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i < width; i += 40) {
                ctx.beginPath();
                ctx.moveTo(i, height - 100);
                ctx.lineTo(i, height);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶æ­¢æŒ¡è£…ç½®ï¼ˆåˆå§‹çŠ¶æ€ï¼‰
            drawBufferDeviceDetail(width / 2, height - 100, 0);
            
            // ç»˜åˆ¶å¹³è½¦ï¼ˆåˆå§‹ä½ç½®ï¼‰
            const carY = 100;
            drawRailcar(width / 2 - 75, carY, 150, 60);
            
            // ç»˜åˆ¶å¼•å¯¼çº¿
            ctx.beginPath();
            ctx.setLineDash([5, 5]);
            ctx.moveTo(width / 2, carY + 60);
            ctx.lineTo(width / 2, height - 100);
            ctx.strokeStyle = 'rgba(52, 152, 219, 0.5)';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.setLineDash([]);
            
            // ç»˜åˆ¶é€Ÿåº¦æŒ‡ç¤º
            ctx.fillStyle = '#27ae60';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`åˆå§‹é€Ÿåº¦: ${simulationParams.speed.toFixed(1)} m/s`, width / 2, 50);
            
            // ç»˜åˆ¶ç¼“å†²åŒºåŸŸæŒ‡ç¤º
            ctx.strokeStyle = 'rgba(52, 152, 219, 0.3)';
            ctx.lineWidth = 2;
            ctx.setLineDash([3, 3]);
            ctx.strokeRect(width / 2 - 70, height - 130, 140, 30);
            ctx.setLineDash([]);
            
            ctx.fillStyle = '#3498db';
            ctx.font = '12px Arial';
            ctx.fillText('ç¼“å†²å« (150mm)', width / 2, height - 135);
            
            // æ›´æ–°è®¾å¤‡æ ‡ç­¾
            updateDeviceLabels({
                compression: 0,
                pressure: 0,
                energyAbsorbed: 0,
                stage: 'idle'
            });
            
            // æ›´æ–°ç¼“å†²çŠ¶æ€æ˜¾ç¤º
            updateBufferStatus();
        }

        // ç»˜åˆ¶åŠ¨ç”»
        function drawAnimation() {
            if (!simulationParams.isRunning || simulationParams.isPaused) return;
            
            const width = canvas.width;
            const height = canvas.height;
            const totalFrames = simulationParams.slowMode ? 360 : 180; // æ…¢æ”¾æ¨¡å¼åŠ å€å¸§æ•°
            const progress = Math.min(animationFrame / totalFrames, 1);
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#0c1e30');
            gradient.addColorStop(1, '#1a3a5f');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // ç»˜åˆ¶åœ°é¢
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(0, height - 100, width, 100);
            
            // è®¡ç®—ç¼“å†²çŠ¶æ€
            const bufferState = updateBufferSystem(progress, simulationParams.speed);
            const bufferHeight = bufferState.compression * 100; // è½¬æ¢ä¸ºåƒç´ 
            
            // è®¡ç®—å¹³è½¦ä½ç½®
            const startY = 100;
            const endY = height - 100 - 60 - bufferHeight;
            const carY = startY + (endY - startY) * Math.min(progress * 1.2, 1);
            
            // ç»˜åˆ¶æ­¢æŒ¡è£…ç½®ï¼ˆå¸¦å‹ç¼©æ•ˆæœï¼‰
            drawBufferDeviceDetail(width / 2, height - 100, bufferHeight);
            
            // ç»˜åˆ¶å¹³è½¦
            drawRailcar(width / 2 - 75, carY, 150, 60);
            
            // ç»˜åˆ¶å†²å‡»åŠ›æŒ‡ç¤º
            const currentForce = calculateExpectedForce(simulationParams.speed) * 
                (progress < 0.3 ? progress/0.3 : progress < 0.7 ? 0.3 + (progress-0.3)/0.4*0.5 : 0.8 + (progress-0.7)/0.3*0.2);
            drawForceIndicator(width / 2 + 100, height - 200, currentForce);
            
            // ç»˜åˆ¶èƒ½é‡æµï¼ˆä»…åœ¨ä¸­æ®µæ˜¾ç¤ºï¼‰
            if (progress > 0.2 && progress < 0.8) {
                drawEnergyFlow(width / 2, carY + 60, width / 2, height - 100 - bufferHeight, progress);
            }
            
            // ç»˜åˆ¶ç¼“å†²çŠ¶æ€ä¿¡æ¯
            ctx.fillStyle = '#ecf0f1';
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            
            // ç¼“å†²é˜¶æ®µæŒ‡ç¤º
            let stageColor, stageText;
            switch(bufferState.stage) {
                case 'elastic':
                    stageColor = '#27ae60';
                    stageText = 'å¼¹æ€§ç¼“å†²é˜¶æ®µ';
                    break;
                case 'hydraulic':
                    stageColor = '#f39c12';
                    stageText = 'æ¶²å‹é˜»å°¼é˜¶æ®µ';
                    break;
                case 'structural':
                    stageColor = '#e74c3c';
                    stageText = 'ç»“æ„é™ä½é˜¶æ®µ';
                    break;
                default:
                    stageColor = '#3498db';
                    stageText = 'å‡†å¤‡é˜¶æ®µ';
            }
            
            ctx.fillStyle = stageColor;
            ctx.font = 'bold 16px Arial';
            ctx.fillText(`å½“å‰é˜¶æ®µ: ${stageText}`, 20, 40);
            
            // åŠ¨æ€å‚æ•°
            ctx.fillStyle = '#ecf0f1';
            ctx.font = '14px Arial';
            ctx.fillText(`ç¼“å†²å‹ç¼©: ${(bufferState.compression * 1000).toFixed(0)} mm`, 20, 70);
            ctx.fillText(`æ¶²å‹å‹åŠ›: ${bufferState.pressure.toFixed(1)} MPa`, 20, 95);
            ctx.fillText(`èƒ½é‡å¸æ”¶: ${bufferState.energyAbsorbed.toFixed(1)}%`, 20, 120);
            
            // è¿›åº¦ä¿¡æ¯
            ctx.fillText(`åŠ¨ç”»è¿›åº¦: ${(progress*100).toFixed(1)}%`, 20, 145);
            if (simulationParams.slowMode) {
                ctx.fillStyle = '#f39c12';
                ctx.fillText('æ…¢æ”¾æ¨¡å¼æ¿€æ´»', 20, 170);
            }
            
            // æ›´æ–°è®¾å¤‡æ ‡ç­¾
            updateDeviceLabels(bufferState);
            
            // æ›´æ–°ç¼“å†²çŠ¶æ€æ˜¾ç¤º
            updateBufferStatus();
            
            animationFrame++;
            
            // ç»§ç»­åŠ¨ç”»ç›´åˆ°å®Œæˆ
            if (animationFrame <= totalFrames) {
                animationId = requestAnimationFrame(drawAnimation);
            } else {
                simulationParams.isRunning = false;
                animationFrame = 0;
            }
        }

        // å¼€å§‹åŠ¨ç”»
        function startAnimation() {
            if (simulationParams.isRunning) return;
            
            // åœæ­¢ä¹‹å‰çš„åŠ¨ç”»
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // è¿è¡Œä»¿çœŸè®¡ç®—
            runSimulation();
            
            // è®¾ç½®åŠ¨ç”»å‚æ•°
            simulationParams.isRunning = true;
            simulationParams.isPaused = false;
            animationFrame = 0;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('pauseBtn').textContent = 'â¸ æš‚åœ';
            
            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            animationId = requestAnimationFrame(drawAnimation);
        }

        // äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–
        function initEventListeners() {
            // å‚æ•°æ§åˆ¶
            document.getElementById('massControl').addEventListener('input', function(e) {
                simulationParams.mass = parseInt(e.target.value) * 1000;
                document.getElementById('massValue').textContent = e.target.value + ' å¨';
            });
            
            document.getElementById('speedControl').addEventListener('input', function(e) {
                const speed = parseFloat(e.target.value);
                simulationParams.speed = speed;
                document.getElementById('speedValue').textContent = speed.toFixed(1) + ' m/s';
                updateScenarioButtons(speed);
            });
            
            document.getElementById('bufferType').addEventListener('input', function(e) {
                const type = parseInt(e.target.value);
                const labels = ['çº¯å¼¹æ€§', 'æ¶²å‹+å¼¹æ€§', 'å¤šçº§ç¼“å†²'];
                simulationParams.bufferType = type;
                document.getElementById('bufferTypeValue').textContent = labels[type - 1];
            });
            
            document.getElementById('dampingControl').addEventListener('input', function(e) {
                simulationParams.damping = parseFloat(e.target.value);
                document.getElementById('dampingValue').textContent = simulationParams.damping.toFixed(1);
            });
            
            // é¢„è®¾å·¥å†µæŒ‰é’®
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const speed = parseFloat(this.getAttribute('data-speed'));
                    
                    // æ›´æ–°é€Ÿåº¦
                    simulationParams.speed = speed;
                    document.getElementById('speedValue').textContent = speed.toFixed(1) + ' m/s';
                    document.getElementById('speedControl').value = speed;
                    
                    // æ ¹æ®é€Ÿåº¦è°ƒæ•´ç¼“å†²ç±»å‹
                    if (speed <= 2.0) {
                        simulationParams.bufferType = 1;
                        document.getElementById('bufferType').value = 1;
                        document.getElementById('bufferTypeValue').textContent = 'çº¯å¼¹æ€§';
                    } else if (speed <= 4.0) {
                        simulationParams.bufferType = 2;
                        document.getElementById('bufferType').value = 2;
                        document.getElementById('bufferTypeValue').textContent = 'æ¶²å‹+å¼¹æ€§';
                    } else {
                        simulationParams.bufferType = 3;
                        document.getElementById('bufferType').value = 3;
                        document.getElementById('bufferTypeValue').textContent = 'å¤šçº§ç¼“å†²';
                    }
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateScenarioButtons(speed);
                });
            });
            
            // æŒ‰é’®æ§åˆ¶
            document.getElementById('startBtn').addEventListener('click', startAnimation);
            
            document.getElementById('pauseBtn').addEventListener('click', function() {
                simulationParams.isPaused = !simulationParams.isPaused;
                this.textContent = simulationParams.isPaused ? 'â–¶ ç»§ç»­' : 'â¸ æš‚åœ';
                
                if (!simulationParams.isPaused && simulationParams.isRunning) {
                    animationId = requestAnimationFrame(drawAnimation);
                }
            });
            
            document.getElementById('resetBtn').addEventListener('click', function() {
                // åœæ­¢åŠ¨ç”»
                simulationParams.isRunning = false;
                simulationParams.isPaused = false;
                simulationParams.slowMode = false;
                
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                
                animationFrame = 0;
                
                // é‡ç½®ç¼“å†²ç³»ç»Ÿ
                bufferSystem = {
                    compression: 0,
                    hydraulicPressure: 0,
                    energyAbsorbed: 0,
                    maxCompression: 0.15,
                    stage: 'idle',
                    compressionRate: 0
                };
                
                // é‡ç½®ç»“æœæ˜¾ç¤º
                document.getElementById('peakForce').textContent = '0.0 kN';
                document.getElementById('maxDeceleration').textContent = '0.0 g';
                document.getElementById('bufferCompression').textContent = '0%';
                document.getElementById('hydraulicPressure').textContent = '0 MPa';
                document.getElementById('energyAbsorbed').textContent = '0%';
                document.getElementById('bufferStatus').className = 'status-indicator status-safe';
                document.getElementById('bufferStatus').textContent = 'å¾…å‘½';
                
                // é‡ç½®å›¾è¡¨æ•°æ®
                forceChart.data.labels = [];
                forceChart.data.datasets[0].data = [];
                forceChart.update();
                
                compressionChart.data.labels = [];
                compressionChart.data.datasets[0].data = [];
                compressionChart.update();
                
                energyChart.data.labels = [];
                energyChart.data.datasets[0].data = [];
                energyChart.data.datasets[1].data = [];
                energyChart.update();
                
                pressureChart.data.labels = [];
                pressureChart.data.datasets[0].data = [];
                pressureChart.update();
                
                // é‡æ–°ç»˜åˆ¶åˆå§‹çŠ¶æ€
                resizeCanvas();
                drawInitialState();
            });
            
            document.getElementById('slowBtn').addEventListener('click', function() {
                simulationParams.slowMode = !simulationParams.slowMode;
                this.textContent = simulationParams.slowMode ? 'â–¶ æ­£å¸¸é€Ÿåº¦' : 'ğŸŒ æ…¢æ”¾æ¨¡å¼';
                this.style.background = simulationParams.slowMode ? 
                    'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)' : 
                    'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
            });
            
            // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´Canvas
            window.addEventListener('resize', function() {
                resizeCanvas();
                if (!simulationParams.isRunning) {
                    drawInitialState();
                }
            });
        }

        // æ›´æ–°é¢„è®¾æŒ‰é’®çŠ¶æ€
        function updateScenarioButtons(currentSpeed) {
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                const btnSpeed = parseFloat(btn.getAttribute('data-speed'));
                if (Math.abs(currentSpeed - btnSpeed) < 0.1) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–Canvaså°ºå¯¸
            resizeCanvas();
            
            // åˆå§‹åŒ–å›¾è¡¨
            initCharts();
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            initEventListeners();
            
            // ç»˜åˆ¶åˆå§‹çŠ¶æ€
            drawInitialState();
        });
    </script>
</body>
</html>
